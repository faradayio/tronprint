require 'tronprint/statistics_formatter'

# Rails helper for displaying footprint data.
module TronprintHelper
  include Tronprint::StatisticsFormatter

  # The total amount of CO2e generated by the application.
  def total_footprint
    total_estimate.to_f
  end

  # The total amount of electricity used by the application.
  def total_electricity
    total_estimate.electricity_use.to_f
  end

  # A URL for the methodology statement of the emissions calculation.
  def footprint_methodology
    Tronprint.statistics.total_footprint_methodology
  end

  # An informational badge displaying total energy, footprint, CO2/minute
  def footprint_badge
    footprint = pounds_with_precision total_estimate

    two_hr_emissions = Tronprint.statistics.
      emission_estimate(Time.now - 7200, Time.now).to_f
    rate = two_hr_emissions / 120  # lbs CO2 per minute over last 2 hours
    rate = pounds_with_precision rate

    text = <<-HTML
      Footprint: #{total_electricity.to_i}W | #{footprint}lbs CO<sub>2</sub>e | #{rate}lbs CO<sub>2</sub>e/min
    HTML

    text.html_safe
  end

  # Let the world know that your app is powered by CM1
  def cm1_badge
    %q{<script type="text/javascript" src="http://carbon.brighterplanet.com/badge.js"></script>}.
      html_safe
  end
  
  def total_estimate
    @total_estimate ||= Tronprint.statistics.emission_estimate
  end
end
